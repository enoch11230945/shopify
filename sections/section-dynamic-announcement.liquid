{%- comment -%}
  AUREA Developer Stack - Dynamic Announcement Bar
  Shows free shipping progress based on cart value
  Per app.md Patch #2
  
  Features:
  - "Free Shipping Over Â£50" message
  - Dynamic progress: "Add Â£12 more for free shipping!"
  - Closeable with localStorage memory
{%- endcomment -%}

{%- assign free_shipping_threshold = section.settings.threshold | default: 50 -%}
{%- assign cart_total = cart.total_price | divided_by: 100.0 -%}
{%- assign amount_remaining = free_shipping_threshold | minus: cart_total -%}

{%- if section.settings.enabled -%}
<div 
  class="dynamic-announcement" 
  id="dynamicAnnouncement"
  data-threshold="{{ free_shipping_threshold }}"
  style="background: {{ section.settings.bg_color }}; color: {{ section.settings.text_color }};"
>
  <div class="container">
    <div class="announcement-content">
      
      {%- if section.settings.show_icon -%}
        <span class="announcement-icon">
          {%- case section.settings.icon_type -%}
            {%- when 'truck' -%}
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="1" y="3" width="15" height="13"></rect>
                <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                <circle cx="5.5" cy="18.5" r="2.5"></circle>
                <circle cx="18.5" cy="18.5" r="2.5"></circle>
              </svg>
            {%- when 'gift' -%}
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 12 20 22 4 22 4 12"></polyline>
                <rect x="2" y="7" width="20" height="5"></rect>
                <line x1="12" y1="22" x2="12" y2="7"></line>
                <path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path>
                <path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path>
              </svg>
            {%- when 'star' -%}
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
              </svg>
            {%- else -%}
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
              </svg>
          {%- endcase -%}
        </span>
      {%- endif -%}
      
      <span class="announcement-text" id="announcementText">
        {%- if cart_total >= free_shipping_threshold -%}
          {{ section.settings.success_message | default: "ðŸŽ‰ You've unlocked FREE UK delivery!" }}
        {%- elsif cart.item_count > 0 -%}
          {{ section.settings.progress_message | replace: '[AMOUNT]', amount_remaining | money_without_trailing_zeros }}
        {%- else -%}
          {{ section.settings.default_message | default: "Free UK delivery on orders over Â£50" }}
        {%- endif -%}
      </span>
      
      {%- if section.settings.show_progress and cart.item_count > 0 and cart_total < free_shipping_threshold -%}
        <div class="announcement-progress">
          <div class="progress-bar" style="width: {{ cart_total | divided_by: free_shipping_threshold | times: 100 | at_most: 100 }}%;"></div>
        </div>
      {%- endif -%}
      
    </div>
    
    {%- if section.settings.closeable -%}
      <button type="button" class="announcement-close" onclick="closeAnnouncement()" aria-label="Close">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    {%- endif -%}
    
  </div>
</div>

<style>
.dynamic-announcement {
  padding: 10px 0;
  font-size: 14px;
  font-weight: 500;
  position: relative;
  z-index: 100;
}

.dynamic-announcement .container {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
}

.announcement-content {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: center;
}

.announcement-icon {
  display: flex;
  align-items: center;
}

.announcement-text {
  text-align: center;
}

.announcement-progress {
  width: 100px;
  height: 4px;
  background: rgba(255,255,255,0.3);
  border-radius: 2px;
  overflow: hidden;
  margin-left: 8px;
}

.progress-bar {
  height: 100%;
  background: #fff;
  border-radius: 2px;
  transition: width 0.3s ease;
}

.announcement-close {
  background: transparent;
  border: none;
  color: inherit;
  cursor: pointer;
  padding: 4px;
  opacity: 0.7;
  transition: opacity 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.announcement-close:hover {
  opacity: 1;
}

.dynamic-announcement.is-hidden {
  display: none;
}

@media (max-width: 768px) {
  .announcement-progress {
    width: 60px;
  }
}
</style>

<script>
(function() {
  'use strict';
  
  const bar = document.getElementById('dynamicAnnouncement');
  if (!bar) return;
  
  const CLOSE_KEY = 'aurea_announcement_closed';
  const threshold = parseFloat(bar.dataset.threshold) || 50;
  
  // Check if previously closed (expires after 24 hours)
  const closedAt = localStorage.getItem(CLOSE_KEY);
  if (closedAt && (Date.now() - parseInt(closedAt)) < 24 * 60 * 60 * 1000) {
    bar.classList.add('is-hidden');
  }
  
  // FIXED: Hook into actual Shopify cart AJAX responses
  // Override fetch to intercept cart updates
  const originalFetch = window.fetch;
  window.fetch = function(url, options) {
    return originalFetch.apply(this, arguments).then(response => {
      // Clone response so we can read it and still return it
      const clone = response.clone();
      
      // Check if this is a cart-related request
      if (typeof url === 'string' && (
        url.includes('/cart/add') || 
        url.includes('/cart/change') || 
        url.includes('/cart/update') ||
        url.includes('/cart.js')
      )) {
        clone.json().then(data => {
          // data could be cart or line item, need to fetch full cart
          fetchCartAndUpdate();
        }).catch(() => {});
      }
      
      return response;
    });
  };
  
  function fetchCartAndUpdate() {
    fetch('/cart.js')
      .then(r => r.json())
      .then(cart => {
        updateAnnouncement(cart.total_price);
      })
      .catch(() => {});
  }
  
  function updateAnnouncement(cartTotal) {
    const remaining = threshold - (cartTotal / 100);
    const textEl = document.getElementById('announcementText');
    
    if (!textEl) return;
    
    if (cartTotal / 100 >= threshold) {
      textEl.textContent = "ðŸŽ‰ You've unlocked FREE UK delivery!";
    } else if (cartTotal > 0) {
      textEl.textContent = `Add Â£${remaining.toFixed(2)} more for FREE delivery!`;
    } else {
      textEl.textContent = 'Free UK delivery on orders over Â£' + threshold;
    }
    
    // Update progress bar
    const progressBar = bar.querySelector('.progress-bar');
    if (progressBar) {
      const percent = Math.min((cartTotal / 100 / threshold) * 100, 100);
      progressBar.style.width = percent + '%';
    }
  }
  
  // Close handler
  window.closeAnnouncement = function() {
    bar.classList.add('is-hidden');
    localStorage.setItem(CLOSE_KEY, Date.now().toString());
  };
  
})();
</script>
{%- endif -%}

{% schema %}
{
  "name": "Dynamic Announcement",
  "tag": "section",
  "class": "section section--dynamic-announcement",
  "settings": [
    {
      "type": "checkbox",
      "id": "enabled",
      "label": "Enable announcement bar",
      "default": true
    },
    {
      "type": "header",
      "content": "Free Shipping"
    },
    {
      "type": "number",
      "id": "threshold",
      "label": "Free shipping threshold (Â£)",
      "default": 50
    },
    {
      "type": "text",
      "id": "default_message",
      "label": "Default message (empty cart)",
      "default": "Free UK delivery on orders over Â£50"
    },
    {
      "type": "text",
      "id": "progress_message",
      "label": "Progress message",
      "default": "Add [AMOUNT] more for FREE delivery!",
      "info": "Use [AMOUNT] for remaining amount"
    },
    {
      "type": "text",
      "id": "success_message",
      "label": "Success message",
      "default": "ðŸŽ‰ You've unlocked FREE UK delivery!"
    },
    {
      "type": "header",
      "content": "Appearance"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background colour",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text colour",
      "default": "#ffffff"
    },
    {
      "type": "checkbox",
      "id": "show_icon",
      "label": "Show icon",
      "default": true
    },
    {
      "type": "select",
      "id": "icon_type",
      "label": "Icon type",
      "options": [
        { "value": "truck", "label": "Delivery Truck" },
        { "value": "gift", "label": "Gift Box" },
        { "value": "star", "label": "Star" },
        { "value": "info", "label": "Info" }
      ],
      "default": "truck"
    },
    {
      "type": "checkbox",
      "id": "show_progress",
      "label": "Show progress bar",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "closeable",
      "label": "Allow users to close",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "Dynamic Announcement"
    }
  ]
}
{% endschema %}
