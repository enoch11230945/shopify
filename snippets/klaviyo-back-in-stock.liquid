{%- comment -%}
  AUREA Developer Stack - Klaviyo Back in Stock Trigger
  Per app.md - integrates with Klaviyo free tier
  
  Usage: {% render 'klaviyo-back-in-stock', product: product, variant: variant %}
  
  Requires: Klaviyo installed (free tier) with Back in Stock flow enabled
{%- endcomment -%}

{%- assign current_variant = variant | default: product.selected_or_first_available_variant -%}
{%- assign is_sold_out = false -%}

{%- unless current_variant.available -%}
  {%- assign is_sold_out = true -%}
{%- endunless -%}

{%- if is_sold_out -%}
<div class="back-in-stock-wrapper" id="backInStockWrapper-{{ product.id }}">
  
  <button 
    type="button" 
    class="btn btn-outline back-in-stock-btn"
    data-bis-trigger
    data-product-id="{{ product.id }}"
    data-variant-id="{{ current_variant.id }}"
    data-product-title="{{ product.title | escape }}"
  >
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M22 17H2a3 3 0 0 0 3-3V9a7 7 0 0 1 14 0v5a3 3 0 0 0 3 3zm-8.27 4a2 2 0 0 1-3.46 0"/>
    </svg>
    Notify Me When Available
  </button>
  
</div>
{%- endif -%}

{%- comment -%}
  Modal and styles are injected via JS on first trigger click
  This ensures only ONE modal exists regardless of how many times this snippet is rendered
{%- endcomment -%}

<script>
(function() {
  'use strict';
  
  // Inject modal HTML only once
  function ensureModalExists() {
    if (document.getElementById('bisModal')) return;
    
    const modalHTML = `
      <div class="bis-modal-overlay" id="bisModalOverlay"></div>
      <div class="bis-modal" id="bisModal">
        <button type="button" class="bis-modal-close" id="bisCloseBtn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
        
        <div class="bis-modal-icon">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M22 17H2a3 3 0 0 0 3-3V9a7 7 0 0 1 14 0v5a3 3 0 0 0 3 3zm-8.27 4a2 2 0 0 1-3.46 0"/>
          </svg>
        </div>
        
        <h3 class="bis-modal-title">Get Notified</h3>
        <p class="bis-modal-subtitle" id="bisProductName">This item is currently sold out</p>
        
        <form class="bis-form" id="bisForm">
          <input type="hidden" name="product_id" id="bisProductId">
          <input type="hidden" name="variant_id" id="bisVariantId">
          
          <div class="bis-form-group">
            <input 
              type="email" 
              name="email" 
              id="bisEmail"
              required 
              placeholder="Enter your email"
              class="bis-input"
            >
          </div>
          
          <button type="submit" class="btn btn-primary bis-submit">
            <span class="bis-submit-text">Notify Me</span>
            <span class="bis-submit-loading" style="display:none;">Submitting...</span>
          </button>
          
          <p class="bis-privacy">
            We'll only email you once when this item is back in stock.
          </p>
        </form>
        
        <div class="bis-success" id="bisSuccess" style="display:none;">
          <div class="bis-success-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#2ecc71" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
              <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
          </div>
          <h4>You're on the list!</h4>
          <p>We'll email you as soon as this item is back in stock.</p>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Bind close handlers
    document.getElementById('bisModalOverlay').addEventListener('click', closeModal);
    document.getElementById('bisCloseBtn').addEventListener('click', closeModal);
    document.getElementById('bisForm').addEventListener('submit', handleSubmit);
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeModal();
    });
  }
  
  function openModal(productId, variantId, productName) {
    ensureModalExists();
    
    document.getElementById('bisProductId').value = productId;
    document.getElementById('bisVariantId').value = variantId;
    document.getElementById('bisProductName').textContent = productName + ' is currently sold out';
    document.getElementById('bisForm').style.display = 'block';
    document.getElementById('bisSuccess').style.display = 'none';
    document.getElementById('bisEmail').value = '';
    document.getElementById('bisModal').classList.add('is-open');
    document.getElementById('bisModalOverlay').classList.add('is-open');
    document.body.style.overflow = 'hidden';
  }
  
  function closeModal() {
    const modal = document.getElementById('bisModal');
    const overlay = document.getElementById('bisModalOverlay');
    if (modal) modal.classList.remove('is-open');
    if (overlay) overlay.classList.remove('is-open');
    document.body.style.overflow = '';
  }
  
  function handleSubmit(e) {
    e.preventDefault();
    
    const form = document.getElementById('bisForm');
    const submitBtn = form.querySelector('.bis-submit');
    const email = document.getElementById('bisEmail').value;
    const variantId = document.getElementById('bisVariantId').value;
    
    // Show loading
    submitBtn.querySelector('.bis-submit-text').style.display = 'none';
    submitBtn.querySelector('.bis-submit-loading').style.display = 'inline';
    submitBtn.disabled = true;
    
    // If Klaviyo is installed, use their Back in Stock API
    if (typeof _learnq !== 'undefined') {
      _learnq.push(['track', 'Back in Stock Subscription', {
        '$email': email,
        'variant': variantId
      }]);
    }
    
    // Simulate success (in real implementation, Klaviyo JS handles this)
    setTimeout(function() {
      form.style.display = 'none';
      document.getElementById('bisSuccess').style.display = 'block';
      
      // Reset button for next use
      submitBtn.querySelector('.bis-submit-text').style.display = 'inline';
      submitBtn.querySelector('.bis-submit-loading').style.display = 'none';
      submitBtn.disabled = false;
      
      // Store locally to prevent duplicate submissions
      try {
        const subscribed = JSON.parse(localStorage.getItem('bis_subscribed') || '[]');
        subscribed.push(variantId);
        localStorage.setItem('bis_subscribed', JSON.stringify(subscribed));
      } catch (err) {}
      
    }, 800);
  }
  
  // Bind click handlers to all BIS trigger buttons
  document.addEventListener('click', function(e) {
    const trigger = e.target.closest('[data-bis-trigger]');
    if (trigger) {
      e.preventDefault();
      openModal(
        trigger.dataset.productId,
        trigger.dataset.variantId,
        trigger.dataset.productTitle
      );
    }
  });
  
})();
</script>

<style>
.back-in-stock-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
  padding: 12px 20px;
  border: 2px solid #d4a574;
  color: #d4a574;
  background: transparent;
  font-weight: 600;
  transition: all 0.2s ease;
  cursor: pointer;
}

.back-in-stock-btn:hover {
  background: #d4a574;
  color: #fff;
}

.bis-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 9998;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.bis-modal-overlay.is-open {
  opacity: 1;
  visibility: visible;
}

.bis-modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.9);
  background: #fff;
  border-radius: 16px;
  padding: 2.5rem;
  max-width: 400px;
  width: 90%;
  z-index: 9999;
  text-align: center;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.bis-modal.is-open {
  opacity: 1;
  visibility: visible;
  transform: translate(-50%, -50%) scale(1);
}

.bis-modal-close {
  position: absolute;
  top: 16px;
  right: 16px;
  background: transparent;
  border: none;
  color: #999;
  cursor: pointer;
  padding: 4px;
}

.bis-modal-close:hover {
  color: #333;
}

.bis-modal-icon {
  color: #d4a574;
  margin-bottom: 1rem;
}

.bis-modal-title {
  font-size: 1.5rem;
  font-weight: 600;
  color: #1a1a1a;
  margin-bottom: 0.5rem;
}

.bis-modal-subtitle {
  font-size: 0.95rem;
  color: #666;
  margin-bottom: 1.5rem;
}

.bis-form-group {
  margin-bottom: 1rem;
}

.bis-input {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid #eee;
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.2s;
  box-sizing: border-box;
}

.bis-input:focus {
  outline: none;
  border-color: #d4a574;
}

.bis-submit {
  width: 100%;
  padding: 12px;
  background: #d4a574;
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.bis-submit:hover {
  background: #c49464;
}

.bis-submit:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}

.bis-privacy {
  font-size: 0.8rem;
  color: #999;
  margin-top: 1rem;
}

.bis-success {
  padding: 1rem 0;
}

.bis-success-icon {
  margin-bottom: 1rem;
}

.bis-success h4 {
  font-size: 1.25rem;
  color: #1a1a1a;
  margin-bottom: 0.5rem;
}

.bis-success p {
  color: #666;
  font-size: 0.95rem;
}
</style>
